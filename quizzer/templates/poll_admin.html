<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Poll Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app" class="container mx-auto px-4 py-8 max-w-4xl">

    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">Poll Admin</h1>
      <button
        @click="showCreateModal = true"
        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition"
      >
        + New Poll
      </button>
    </div>

    <!-- Loading -->
    <div v-if="loading" class="text-center py-12">
      <div class="animate-spin h-8 w-8 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto"></div>
      <p class="mt-4 text-gray-600">Loading polls...</p>
    </div>

    <!-- Empty State -->
    <div v-else-if="polls.length === 0" class="text-center py-12 bg-white rounded-lg shadow">
      <p class="text-gray-500 text-lg">No polls yet</p>
      <button
        @click="showCreateModal = true"
        class="mt-4 text-indigo-600 hover:text-indigo-800 font-medium"
      >
        Create your first poll
      </button>
    </div>

    <!-- Polls List -->
    <div v-else class="space-y-4">
      <div
        v-for="poll in polls"
        :key="poll.id"
        class="bg-white rounded-lg shadow p-6"
      >
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs font-mono">#{{ poll.id }}</span>
              <h2 class="text-xl font-semibold text-gray-800">{{ poll.question }}</h2>
              <span
                :class="poll.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'"
                class="px-2 py-0.5 rounded text-xs font-medium"
              >
                {{ poll.active ? 'Active' : 'Inactive' }}
              </span>
            </div>
            <p v-if="poll.description" class="text-gray-600 text-sm mb-3">{{ poll.description }}</p>

            <!-- Answers -->
            <div class="space-y-2">
              <div
                v-for="answer in poll.answers"
                :key="answer.id"
                class="bg-gray-50 rounded px-3 py-2"
              >
                <div class="flex items-center justify-between mb-1">
                  <span class="text-gray-700">{{ answer.text }}</span>
                  <span class="text-sm text-gray-500">
                    {{ answer.votes_count }} votes ({{ getPercentage(answer, poll) }}%)
                  </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div
                    class="bg-indigo-500 h-2 rounded-full transition-all duration-300"
                    :style="{ width: getPercentage(answer, poll) + '%' }"
                  ></div>
                </div>
              </div>
            </div>

            <div class="mt-3 text-sm text-gray-500">
              Total votes: {{ getTotalVotes(poll) }} |
              Created: {{ formatDate(poll.created_at) }}
            </div>
          </div>

          <!-- Actions -->
          <div class="flex gap-2 ml-4">
            <button
              @click="showQrCode(poll)"
              class="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded transition"
              title="QR Code"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
              </svg>
            </button>
            <button
              @click="copyPollLink(poll)"
              class="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded transition"
              title="Copy link"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            </button>
            <button
              @click="openEditModal(poll)"
              class="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded transition"
              title="Edit"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </button>
            <button
              @click="toggleActive(poll)"
              class="p-2 text-gray-500 hover:text-yellow-600 hover:bg-yellow-50 rounded transition"
              :title="poll.active ? 'Deactivate' : 'Activate'"
            >
              <svg v-if="poll.active" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </button>
            <button
              @click="clearVotes(poll)"
              class="p-2 text-gray-500 hover:text-orange-600 hover:bg-orange-50 rounded transition"
              title="Clear votes"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </button>
            <button
              @click="deletePoll(poll)"
              class="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded transition"
              title="Delete"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Create/Edit Modal -->
    <div
      v-if="showCreateModal || showEditModal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"
    >
      <div class="bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">
            {{ showEditModal ? 'Edit Poll' : 'Create New Poll' }}
          </h2>

          <form @submit.prevent="showEditModal ? updatePoll() : createPoll()">
            <!-- Question -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Question *</label>
              <input
                v-model="form.question"
                type="text"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="What would you like to ask?"
              />
            </div>

            <!-- Description -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <textarea
                v-model="form.description"
                rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="Optional description or context"
              ></textarea>
            </div>

            <!-- Answers -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Answers *</label>
              <div class="space-y-2">
                <div
                  v-for="(answer, idx) in form.answers"
                  :key="idx"
                  class="flex gap-2"
                >
                  <input
                    v-model="form.answers[idx]"
                    type="text"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    :placeholder="'Answer ' + (idx + 1)"
                  />
                  <button
                    type="button"
                    @click="removeAnswer(idx)"
                    :disabled="form.answers.length <= 2"
                    class="p-2 text-gray-400 hover:text-red-600 disabled:opacity-30 disabled:cursor-not-allowed"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
              <button
                type="button"
                @click="addAnswer"
                class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-medium"
              >
                + Add another answer
              </button>
            </div>

            <!-- Active Toggle -->
            <div class="mb-6">
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  v-model="form.active"
                  class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                />
                <span class="text-sm text-gray-700">Poll is active</span>
              </label>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-3">
              <button
                type="button"
                @click="closeModals"
                class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition"
              >
                Cancel
              </button>
              <button
                type="submit"
                :disabled="saving"
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition disabled:opacity-50"
              >
                {{ saving ? 'Saving...' : (showEditModal ? 'Update Poll' : 'Create Poll') }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- QR Code Modal -->
    <div
      v-if="showQrModal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"
      @click.self="showQrModal = false"
    >
      <div class="bg-white rounded-xl shadow-xl p-6 max-w-sm w-full text-center">
        <h2 class="text-xl font-bold text-gray-800 mb-2">Poll #{{ qrPoll?.id }}</h2>
        <p class="text-gray-600 text-sm mb-4 truncate">{{ qrPoll?.question }}</p>

        <div class="bg-white p-4 rounded-lg inline-block mb-4">
          <div id="qrContainer"></div>
        </div>

        <p class="text-xs text-gray-500 mb-4 break-all">{{ qrUrl }}</p>

        <div class="flex gap-2 justify-center">
          <button
            @click="downloadQrCode"
            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition"
          >
            Download
          </button>
          <button
            @click="showQrModal = false"
            class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div
      v-if="toast.show"
      :class="toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'"
      class="fixed bottom-4 right-4 text-white px-4 py-2 rounded-lg shadow-lg transition-all"
    >
      {{ toast.message }}
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          polls: [],
          loading: true,
          showCreateModal: false,
          showEditModal: false,
          showQrModal: false,
          editingPollId: null,
          saving: false,
          qrPoll: null,
          qrUrl: '',
          form: {
            question: '',
            description: '',
            answers: ['', ''],
            active: true
          },
          toast: {
            show: false,
            message: '',
            type: 'success'
          }
        };
      },
      methods: {
        async fetchPolls() {
          try {
            const response = await fetch('/api/v1/polls/admin');
            const data = await response.json();
            if (data.success) {
              this.polls = data.polls;
            }
          } catch (err) {
            this.showToast('Failed to load polls', 'error');
          } finally {
            this.loading = false;
          }
        },

        async createPoll() {
          if (!this.form.question || this.form.answers.filter(a => a.trim()).length < 2) {
            this.showToast('Please provide a question and at least 2 answers', 'error');
            return;
          }

          this.saving = true;
          try {
            const response = await fetch('/api/v1/polls/admin', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                question: this.form.question,
                description: this.form.description,
                answers: this.form.answers.filter(a => a.trim()),
                active: this.form.active
              })
            });

            const data = await response.json();
            if (data.success) {
              this.polls.unshift(data.poll);
              this.closeModals();
              this.showToast('Poll created successfully');
            } else {
              this.showToast(data.message || 'Failed to create poll', 'error');
            }
          } catch (err) {
            this.showToast('Failed to create poll', 'error');
          } finally {
            this.saving = false;
          }
        },

        openEditModal(poll) {
          this.editingPollId = poll.id;
          this.form = {
            question: poll.question,
            description: poll.description || '',
            answers: poll.answers.map(a => a.text),
            active: poll.active
          };
          if (this.form.answers.length < 2) {
            this.form.answers.push('');
          }
          this.showEditModal = true;
        },

        async updatePoll() {
          if (!this.form.question || this.form.answers.filter(a => a.trim()).length < 2) {
            this.showToast('Please provide a question and at least 2 answers', 'error');
            return;
          }

          this.saving = true;
          try {
            const response = await fetch(`/api/v1/polls/admin/${this.editingPollId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                question: this.form.question,
                description: this.form.description,
                answers: this.form.answers.filter(a => a.trim()),
                active: this.form.active
              })
            });

            const data = await response.json();
            if (data.success) {
              const idx = this.polls.findIndex(p => p.id === this.editingPollId);
              if (idx !== -1) {
                this.polls[idx] = data.poll;
              }
              this.closeModals();
              this.showToast('Poll updated successfully');
            } else {
              this.showToast(data.message || 'Failed to update poll', 'error');
            }
          } catch (err) {
            this.showToast('Failed to update poll', 'error');
          } finally {
            this.saving = false;
          }
        },

        async toggleActive(poll) {
          try {
            const response = await fetch(`/api/v1/polls/admin/${poll.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ active: !poll.active })
            });

            const data = await response.json();
            if (data.success) {
              poll.active = !poll.active;
              this.showToast(`Poll ${poll.active ? 'activated' : 'deactivated'}`);
            }
          } catch (err) {
            this.showToast('Failed to update poll', 'error');
          }
        },

        async deletePoll(poll) {
          if (!confirm(`Delete "${poll.question}"? This cannot be undone.`)) {
            return;
          }

          try {
            const response = await fetch(`/api/v1/polls/admin/${poll.id}`, {
              method: 'DELETE'
            });

            const data = await response.json();
            if (data.success) {
              this.polls = this.polls.filter(p => p.id !== poll.id);
              this.showToast('Poll deleted');
            } else {
              this.showToast(data.message || 'Failed to delete poll', 'error');
            }
          } catch (err) {
            this.showToast('Failed to delete poll', 'error');
          }
        },

        async clearVotes(poll) {
          const totalVotes = this.getTotalVotes(poll);
          if (totalVotes === 0) {
            this.showToast('No votes to clear', 'error');
            return;
          }

          if (!confirm(`Are you sure you want to clear all ${totalVotes} vote${totalVotes !== 1 ? 's' : ''} from "${poll.question}"? This cannot be undone.`)) {
            return;
          }

          try {
            const response = await fetch(`/api/v1/polls/${poll.id}/clear-votes`, {
              method: 'POST'
            });

            const data = await response.json();
            if (data.success) {
              const idx = this.polls.findIndex(p => p.id === poll.id);
              if (idx !== -1) {
                this.polls[idx] = data.poll;
              }
              this.showToast('All votes cleared');
            } else {
              this.showToast(data.message || 'Failed to clear votes', 'error');
            }
          } catch (err) {
            this.showToast('Failed to clear votes', 'error');
          }
        },

        copyPollLink(poll) {
          const url = `${window.location.origin}/polls/${poll.id}`;
          navigator.clipboard.writeText(url).then(() => {
            this.showToast('Link copied to clipboard');
          }).catch(() => {
            this.showToast('Failed to copy link', 'error');
          });
        },

        showQrCode(poll) {
          this.qrPoll = poll;
          this.qrUrl = `${window.location.origin}/polls/${poll.id}`;
          this.showQrModal = true;

          this.$nextTick(() => {
            const container = document.getElementById('qrContainer');
            container.innerHTML = '';

            const qr = qrcode(0, 'M');
            qr.addData(this.qrUrl);
            qr.make();

            const img = document.createElement('img');
            img.src = qr.createDataURL(6, 4);
            img.id = 'qrImage';
            img.style.width = '200px';
            img.style.height = '200px';
            container.appendChild(img);
          });
        },

        downloadQrCode() {
          const img = document.getElementById('qrImage');
          const link = document.createElement('a');
          link.download = `poll-${this.qrPoll.id}-qrcode.png`;
          link.href = img.src;
          link.click();
          this.showToast('QR code downloaded');
        },

        addAnswer() {
          this.form.answers.push('');
        },

        removeAnswer(idx) {
          if (this.form.answers.length > 2) {
            this.form.answers.splice(idx, 1);
          }
        },

        closeModals() {
          this.showCreateModal = false;
          this.showEditModal = false;
          this.editingPollId = null;
          this.form = {
            question: '',
            description: '',
            answers: ['', ''],
            active: true
          };
        },

        getTotalVotes(poll) {
          return poll.answers.reduce((sum, a) => sum + a.votes_count, 0);
        },

        getPercentage(answer, poll) {
          const total = this.getTotalVotes(poll);
          if (total === 0) return 0;
          return Math.round((answer.votes_count / total) * 100);
        },

        formatDate(dateStr) {
          if (!dateStr) return '';
          return new Date(dateStr).toLocaleDateString();
        },

        showToast(message, type = 'success') {
          this.toast = { show: true, message, type };
          setTimeout(() => {
            this.toast.show = false;
          }, 3000);
        }
      },
      mounted() {
        this.fetchPolls();
      }
    }).mount('#app');
  </script>
</body>
</html>
